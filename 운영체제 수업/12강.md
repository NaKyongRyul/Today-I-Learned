## 2022-04-14

## 다중 스레드 서버 구조

1. 클라이언트 1이 80번 포트를 통해 request하면 이는 웹서버에게 전달된다. 80번 포트는 listen만 한다.
2. 웹서버가 요청을 서비스할 새로운 스레드를 생성한다. 이 때, 80번 포트는 다시 listen 모드로 돌아간다.
3. 스레드가 클라이언트에게 response를 보낸다.

<br/>

## 다중 스레드 프로그래밍의 이점

- 응답성 <br/>
  채팅을 보내는 중에 상대방이 보낸 것을 읽을 수 있는 것처럼 사용자에 대한 응답성을 증가시킨다.

- 자원 공유 <br/>
  하나의 프로세스는 여러 스레드를 가질 수 있고 이 스레드들은 프로세스에 할당된 자원들을 공유할 수 있다. 그래서 따로 스레드들에 자원할당을 할 필요가 없어서 속도가 더 빠르다.

- 경제성 <br/>
  스레드 생성이나 문맥교환이 프로세스 생성이나 문맥교환보다 더 싸고 메모리도 덜 소비한다. 프로세스간 문맥교환은 RAM에 들어있는 프로세스1을 빼고 프로세스2를 넣고 해야하지만 스레드간 문맥교환은 스레드1에 있는 레지스터 값들을 스레드2에 있는 레지스터 값들로 이동하면 된다.
- 규모 적응성 <br/>
  다중 처리기 구조에서 스레드가 병렬로 처리될 수 있으므로 효율적이다.

<br/>

## 병행성과 병렬성

싱클코어 시스템에서는 스레드가 하나씩 실행되는데 각 스레드마다 time slice가 있기 때문애 그 시간을 넘어가면 다음 스레드를 실행한다. 그래서 마치 동시에 실행되는 것처럼 보인다. 이것은 병행성이고 실제로 스레드들을 같이 실행하지는 않으므로 병렬성은 아니다.

<br/>

멀티코어 시스템에서는 코어가 여러개이므로 스레드를 동시에 실행할 수 있다. 따라서 병렬성을 가진다.

<br/>

병행성은 싱글•멀티코어 시스템 모두가 가질 수 있지만 병렬성은 멀티코어 시스템만 가질 수 있다.

## 다중 스레드 모델

1. Many-to-one

   <img width="351" alt="스크린샷 2022-04-17 오후 1 32 36" src="https://user-images.githubusercontent.com/67616146/163700592-c0b50808-5f86-437d-83b7-7075d49212d5.png">

   커널 스레드가 하나이기 때문에 운영체제에 부담이 없지만 병렬로 실행될 수 없다.

<br/>

2. one-to-one

   <img width="356" alt="스크린샷 2022-04-17 오후 1 32 43" src="https://user-images.githubusercontent.com/67616146/163700595-30dbdf47-a2d8-48a0-bd0f-3434f76602ed.png">

   유저레벨 스레드가 만들어지면 거기에 따라서 커널레벨 스레드가 만들어지니까 운영체제의 부하가 커진다. 하지만 병렬로 실행될 수 있다는 장점을 가진다.

<br/>

3. Many-to-Many

   <img width="349" alt="스크린샷 2022-04-17 오후 1 32 50" src="https://user-images.githubusercontent.com/67616146/163700596-dcde63c6-9e7e-479e-b7fa-28285d1486a3.png">

   1,2의 단점을 어느정도 해결한 모델로 필요한만큼 유저 스레드를 만들 수 있고 커널 스레드가 병렬로 수행될 수도 있다. 하지만 만들기가 어렵고 복잡하므로 오류가 날 가능성이 더 높다.

<br/>

CPU에서는 유저레벨 스레드를 사용하지 못하고 커널레벨 스레드만 사용할 수 있다.(앞에서 배운 사용자 프로그램이 하드웨어에 직접 접근할 수 없다의 의미이다)

## Implict Threading (암묵적 스레딩)

스레드를 통해서 작업을 병렬적으로 하는 것이 효율적이라는 것을 알고 있다. 그런데 스레드를 생성하거나 종료되서 마무리 작업을 하는데 시간이 많이 소요된다.

암묵적 스레딩은 이런 책임을 컴파일러와 실행시간 라이브러리에게 넘겨준다.
이는 응용 프로그램 개발자가 병렬로 실행할 수 있는 스레드가 아닌 작업을 식별해야 한다.

### 스레드 풀

위에서와 같이 다중 스레드 서버는 서비스할 떄마다 생성되는 스레드의 소요시간 문제와 동시에 실행할 수 있는 최대 스레드 수를 제한해야 하는 문제가 있다. 이를 해결할 수 있는 방법이 스레드 풀이다.

## 스레드와 관련된 문제들

### fork(), exec() 시스템 콜

fork()는 모든 스레드를 가진 프로세스와 fork()를 호출한 스레드를 가진 프로세스를 복제하는 두 가지 방법 모두를 제공한다.

exec()는 모든 스레드를 가진 프로세스만 복제할 수 있다.
